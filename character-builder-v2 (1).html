<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>‚öîÔ∏è RPG Character Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; }
  body {
    font-family: 'Silkscreen', monospace;
    background: linear-gradient(160deg, #0c0c1d 0%, #1a1a35 40%, #0d2137 100%);
    color: #ccc;
    touch-action: manipulation;
  }
  @keyframes shimmer { 0%,100%{box-shadow:0 0 12px rgba(100,220,200,0.2)} 50%{box-shadow:0 0 24px rgba(100,220,200,0.45)} }

  #app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

  .topbar { display:flex; align-items:center; gap:8px; padding:6px 10px; border-bottom:1px solid #1a3050; flex-shrink:0; flex-wrap:wrap; }
  .topbar .title { color:#64dcc8; font-size:clamp(11px,2.5vw,14px); letter-spacing:2px; text-shadow:0 0 20px rgba(100,220,200,0.4); white-space:nowrap; }
  .topbar input { font-family:'Silkscreen',monospace; font-size:11px; padding:4px 8px; background:#111a30; color:#64dcc8; border:1px solid #1a3050; border-radius:6px; outline:none; width:100%; max-width:180px; }
  .topbar input::placeholder { color:#445566; }
  .topbar .btns { display:flex; gap:6px; }
  .btn { font-family:'Silkscreen',monospace; font-size:10px; padding:5px 10px; color:#fff; border:none; border-radius:7px; cursor:pointer; transition:all .1s; }
  .btn:active { transform:scale(0.95); }
  .btn-rand { background:#d35f5f; box-shadow:0 3px 10px #d35f5f44; }
  .btn-save { background:#2980b9; box-shadow:0 3px 10px #2980b944; }

  .main { flex:1; display:flex; overflow:hidden; min-height:0; }

  .preview { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px; flex-shrink:0; }
  .scene { border-radius:10px; padding:4px; animation:shimmer 4s ease-in-out infinite; display:flex; justify-content:center; align-items:center; width:min(95%,420px); aspect-ratio:16/9; background:#0a0a18; }
  .scene canvas { image-rendering:pixelated; width:100%; height:100%; border-radius:6px; }
  .scene.transparent canvas { background:repeating-conic-gradient(#333 0% 25%, #555 0% 50%) 0 0/12px 12px; }
  .nameplate { margin-top:8px; padding:3px 14px; background:rgba(100,220,200,0.08); border:1px solid #1a3858; border-radius:6px; color:#64dcc8; font-size:clamp(10px,2vw,13px); text-align:center; letter-spacing:1px; max-width:95%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .divider { width:8px; cursor:col-resize; background:#1a3050; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:background .15s; touch-action:none; }
  .divider:hover, .divider:active { background:#2a4060; }
  .divider::after { content:''; display:block; width:2px; height:32px; border-radius:1px; background:#3a5a7a; box-shadow:4px 0 0 #3a5a7a; }

  .controls { flex:1; display:flex; flex-direction:column; min-width:0; overflow:hidden; }
  .tabs { display:flex; border-bottom:2px solid #1a3050; flex-shrink:0; }
  .tab { font-family:'Silkscreen',monospace; font-size:9px; padding:6px 4px; flex:1; background:#111a30; color:#667788; border:none; border-bottom:3px solid transparent; cursor:pointer; transition:all .1s; white-space:nowrap; }
  .tab:hover { background:#1e2d50; }
  .tab.on { background:#0d2137; border-bottom-color:#64dcc8; color:#64dcc8; }
  .tab .icon { font-size:13px; display:block; }
  .options { flex:1; overflow-y:auto; padding:8px 12px; }
  .sec { margin-bottom:10px; }
  .sec-label { color:#64dcc8; font-size:9px; margin-bottom:5px; text-transform:uppercase; letter-spacing:1.5px; }
  .swatches { display:flex; gap:3px; flex-wrap:wrap; align-items:center; }
  .sw { width:22px; height:22px; border-radius:4px; border:2px solid transparent; cursor:pointer; transition:all .1s; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
  .sw:hover { transform:scale(1.2); z-index:1; }
  .sw.on { border-color:#64dcc8; box-shadow:0 0 8px rgba(100,220,200,0.5); }
  .sw-none { background:#111a30; color:#556; font-size:11px; }
  .textbtns { display:flex; gap:4px; flex-wrap:wrap; }
  .tx { font-family:'Silkscreen',monospace; font-size:9px; padding:4px 8px; background:#111a30; color:#556677; border:1px solid #1a3050; border-radius:5px; cursor:pointer; transition:all .08s; }
  .tx:hover { transform:translateY(-1px); filter:brightness(1.3); }
  .tx.on { background:#1a3858; color:#64dcc8; border-color:#2a5878; outline:2px solid #64dcc8; outline-offset:1px; }
  .slider-row { display:flex; align-items:center; gap:8px; }
  .slider-row input[type=range] { flex:1; accent-color:#64dcc8; height:6px; }
  .slider-val { color:#64dcc8; font-size:11px; min-width:40px; text-align:right; }

  .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; }
  .modal { background:#111a30; border:2px solid #64dcc8; border-radius:14px; padding:20px; display:flex; flex-direction:column; align-items:center; gap:12px; max-width:90vw; }
  .modal .modal-title { color:#64dcc8; font-size:16px; }
  .modal img { image-rendering:pixelated; width:min(512px,85vw); height:auto; border:2px solid #1a3050; border-radius:8px; }
  .modal .hint { color:#8899aa; font-size:9px; text-align:center; line-height:1.6; }
  .modal .close-btn { font-family:'Silkscreen',monospace; font-size:11px; padding:6px 18px; background:#d35f5f; color:#fff; border:none; border-radius:8px; cursor:pointer; }

  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:#64dcc8; border-radius:3px; }
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <span class="title">‚öîÔ∏è Character Builder</span>
    <div style="flex:1;min-width:80px"><input id="nameInput" value="Hero" placeholder="Name..."></div>
    <div class="btns">
      <button class="btn btn-rand" id="btnRandom">üé≤ Random</button>
      <button class="btn btn-save" id="btnSave">üíæ Save</button>
    </div>
  </div>
  <div class="main" id="mainArea">
    <div class="preview" id="previewPanel">
      <div class="scene">
        <canvas id="sceneCanvas" width="128" height="72"></canvas>
      </div>
      <div class="nameplate" id="nameplate">Hero</div>
    </div>
    <div class="divider" id="divider"></div>
    <div class="controls">
      <div class="tabs" id="tabBar"></div>
      <div class="options" id="optionsPanel"></div>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal" style="display:none">
  <div class="modal">
    <div class="modal-title" id="modalTitle">Your Character</div>
    <img id="modalImg" src="" alt="Character">
    <div class="hint">Long-press the image and<br>choose "Save Image"</div>
    <button class="close-btn" id="modalClose">Close</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RPG CHARACTER BUILDER v2 - Phase 1
// Landscape canvas, backgrounds, weather, height
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SW = 128, SH = 72;       // Scene canvas size
const CW = 32, CH = 32;        // Character sprite size
const GROUND_Y = 60;            // Ground line in scene
const PPF = GROUND_Y * 0.85 / 12; // Pixels per foot (~4.25)

// ‚îÄ‚îÄ‚îÄ Palettes (unchanged from v1) ‚îÄ‚îÄ‚îÄ
const SKIN = {
  Light:{base:"#f5c8a0",shade:"#d4a070",hi:"#ffe0c0"},
  Tan:{base:"#d4a060",shade:"#b08040",hi:"#e8c080"},
  Brown:{base:"#8b5e3c",shade:"#6b3e1c",hi:"#a07850"},
  Dark:{base:"#5c3a1e",shade:"#3c2a10",hi:"#7a5030"},
  Olive:{base:"#b8a878",shade:"#908060",hi:"#d0c090"},
  Pale:{base:"#ffe8d8",shade:"#e0c0a8",hi:"#fff0e8"},
  Zombie:{base:"#7a9a50",shade:"#5a7a30",hi:"#90b060"},
};
const HAIR_COLORS = {
  Brown:{base:"#6b3a1a",shade:"#4a2510",hi:"#8a5030"},
  Black:{base:"#1a1a2e",shade:"#0a0a18",hi:"#2e2e48"},
  Blonde:{base:"#e0c060",shade:"#c0a040",hi:"#f0d880"},
  Red:{base:"#b03020",shade:"#802010",hi:"#d04830"},
  White:{base:"#d8d8e0",shade:"#b0b0c0",hi:"#f0f0f8"},
  Blue:{base:"#3060c0",shade:"#2040a0",hi:"#4878e0"},
  Green:{base:"#308030",shade:"#206020",hi:"#48a848"},
  Pink:{base:"#e06898",shade:"#c04878",hi:"#f088b0"},
  Purple:{base:"#7030a0",shade:"#502080",hi:"#9048c0"},
};
const CLOTH = {
  Red:{base:"#c03030",shade:"#901818",hi:"#e04848"},
  Blue:{base:"#3050b0",shade:"#203888",hi:"#4868d0"},
  Green:{base:"#308838",shade:"#206820",hi:"#48a850"},
  Teal:{base:"#308888",shade:"#206868",hi:"#48a8a8"},
  Purple:{base:"#703098",shade:"#502078",hi:"#9048b8"},
  White:{base:"#d8d8e0",shade:"#b0b0c0",hi:"#f0f0f8"},
  Black:{base:"#2a2a38",shade:"#18182a",hi:"#404058"},
  Brown:{base:"#785030",shade:"#583818",hi:"#987048"},
  Orange:{base:"#d07020",shade:"#a05010",hi:"#e89038"},
  Yellow:{base:"#d0b020",shade:"#a89018",hi:"#e8c838"},
  Maroon:{base:"#702030",shade:"#501018",hi:"#903848"},
  Navy:{base:"#202860",shade:"#101848",hi:"#384078"},
  Gray:{base:"#787888",shade:"#585868",hi:"#9898a8"},
  Pink:{base:"#e06888",shade:"#c04868",hi:"#f888a8"},
};
const EYE = {Blue:"#4488dd",Brown:"#885522",Green:"#44aa44",Gray:"#888899",Red:"#cc3333",Purple:"#8844cc",Gold:"#ccaa22",Black:"#222233"};
const METAL = {
  Steel:{base:"#a0a8b8",shade:"#707888",hi:"#c8d0e0"},
  Gold:{base:"#d0a830",shade:"#a08018",hi:"#e8c848"},
  Bronze:{base:"#b08030",shade:"#886018",hi:"#c89848"},
  Iron:{base:"#686878",shade:"#484858",hi:"#888898"},
};

// ‚îÄ‚îÄ‚îÄ Pixel helpers ‚îÄ‚îÄ‚îÄ
function px(c,x,y,color){c.fillStyle=color;c.fillRect(x,y,1,1);}
function rc(c,x,y,w,h,color){c.fillStyle=color;c.fillRect(x,y,w,h);}

// Pixel-perfect triangle fill (scanline)
function tri(c,x1,y1,x2,y2,x3,y3,color){
  c.fillStyle=color;
  const minY=Math.floor(Math.min(y1,y2,y3)),maxY=Math.ceil(Math.max(y1,y2,y3));
  for(let y=minY;y<=maxY;y++){
    let xs=[];
    [[x1,y1,x2,y2],[x2,y2,x3,y3],[x3,y3,x1,y1]].forEach(([ax,ay,bx,by])=>{
      if(y>=Math.min(ay,by)&&y<=Math.max(ay,by)&&ay!==by)
        xs.push(Math.round(ax+(y-ay)*(bx-ax)/(by-ay)));
    });
    if(xs.length>=2){xs.sort((a,b)=>a-b);c.fillRect(xs[0],y,xs[xs.length-1]-xs[0]+1,1);}
  }
}

// ‚îÄ‚îÄ‚îÄ Character drawing functions (unchanged from v1) ‚îÄ‚îÄ‚îÄ
function drawBody(c,skin){
  const s=SKIN[skin];
  rc(c,12,2,8,1,s.base);rc(c,11,3,10,8,s.base);rc(c,12,11,8,1,s.base);
  rc(c,11,3,1,8,s.shade);rc(c,20,3,1,8,s.shade);rc(c,12,10,8,1,s.shade);rc(c,12,11,8,1,s.shade);
  rc(c,13,3,6,1,s.hi);px(c,12,3,s.hi);
  rc(c,14,12,4,1,s.base);rc(c,14,12,1,1,s.shade);
  rc(c,11,13,10,8,s.base);rc(c,11,13,1,8,s.shade);rc(c,20,13,1,8,s.shade);rc(c,11,20,10,1,s.shade);
  rc(c,8,13,3,8,s.base);rc(c,21,13,3,8,s.base);
  rc(c,8,13,1,8,s.shade);rc(c,23,13,1,8,s.shade);rc(c,8,20,3,1,s.shade);rc(c,21,20,3,1,s.shade);
  rc(c,8,21,3,2,s.base);rc(c,21,21,3,2,s.base);rc(c,8,22,3,1,s.shade);rc(c,21,22,3,1,s.shade);
}
function drawEyes(c,col){
  const v=EYE[col];
  rc(c,13,6,3,2,"#e8e8f0");rc(c,17,6,3,2,"#e8e8f0");
  rc(c,14,6,2,2,v);rc(c,18,6,2,2,v);
  px(c,14,6,"#fff");px(c,18,6,"#fff");
  px(c,13,6,"#000");px(c,15,6,"#000");px(c,17,6,"#000");px(c,19,6,"#000");
}
function drawMouth(c,skin){
  const s=SKIN[skin];px(c,14,9,s.shade);rc(c,15,9,2,1,"#c06060");px(c,17,9,s.shade);
}
function drawHair(c,style,color){
  if(style==="None")return;const h=HAIR_COLORS[color];
  if(style==="Short"){
    rc(c,11,1,10,3,h.base);rc(c,10,2,1,4,h.base);rc(c,21,2,1,4,h.base);
    rc(c,11,1,10,1,h.hi);rc(c,10,2,1,2,h.shade);rc(c,21,2,1,2,h.shade);
  }else if(style==="Messy"){
    rc(c,10,0,12,4,h.base);rc(c,10,2,1,5,h.base);rc(c,21,2,1,5,h.base);
    px(c,9,1,h.base);px(c,22,1,h.base);px(c,9,3,h.base);px(c,22,4,h.base);
    rc(c,10,0,12,1,h.hi);rc(c,10,4,1,3,h.shade);rc(c,21,4,1,3,h.shade);
  }else if(style==="Long"){
    rc(c,10,0,12,4,h.base);rc(c,10,2,2,16,h.base);rc(c,20,2,2,16,h.base);
    rc(c,10,0,12,1,h.hi);rc(c,10,4,1,14,h.shade);rc(c,21,4,1,14,h.shade);
  }else if(style==="Mohawk"){
    rc(c,14,-1,4,5,h.base);rc(c,13,2,6,2,h.base);
    rc(c,14,-1,4,1,h.hi);rc(c,15,-1,2,1,h.shade);
  }else if(style==="Ponytail"){
    rc(c,11,1,10,3,h.base);rc(c,10,2,1,4,h.base);rc(c,21,2,1,4,h.base);
    rc(c,20,6,2,10,h.base);rc(c,21,6,1,10,h.shade);rc(c,11,1,10,1,h.hi);
  }else if(style==="Curly"){
    rc(c,10,0,12,5,h.base);rc(c,9,2,1,5,h.base);rc(c,22,2,1,5,h.base);
    px(c,10,6,h.base);px(c,21,6,h.base);
    rc(c,10,0,12,1,h.hi);px(c,11,1,h.hi);px(c,13,1,h.hi);px(c,17,1,h.hi);px(c,19,1,h.hi);
    rc(c,9,5,1,2,h.shade);rc(c,22,5,1,2,h.shade);
  }else if(style==="Spiky"){
    rc(c,11,1,10,3,h.base);rc(c,10,2,1,4,h.base);rc(c,21,2,1,4,h.base);
    px(c,11,0,h.base);px(c,13,-1,h.base);px(c,14,0,h.base);
    px(c,16,-1,h.base);px(c,17,0,h.base);px(c,19,-1,h.base);px(c,20,0,h.base);
    px(c,13,-1,h.hi);px(c,16,-1,h.hi);px(c,19,-1,h.hi);
  }
}
function drawShirt(c,color){
  if(color==="None")return;const v=CLOTH[color];
  rc(c,11,13,10,8,v.base);rc(c,8,13,3,6,v.base);rc(c,21,13,3,6,v.base);
  rc(c,11,13,1,8,v.shade);rc(c,20,13,1,8,v.shade);rc(c,8,13,1,6,v.shade);rc(c,23,13,1,6,v.shade);
  rc(c,11,20,10,1,v.shade);rc(c,14,13,4,1,v.hi);rc(c,14,12,4,1,v.shade);
  px(c,15,13,v.shade);px(c,16,13,v.shade);
}
function drawPants(c,color){
  if(color==="None")return;const v=CLOTH[color];
  rc(c,11,21,5,7,v.base);rc(c,16,21,5,7,v.base);
  px(c,15,25,v.shade);px(c,16,25,v.shade);
  rc(c,11,21,1,7,v.shade);rc(c,20,21,1,7,v.shade);
  rc(c,11,27,5,1,v.shade);rc(c,16,27,5,1,v.shade);rc(c,11,21,10,1,v.shade);
  rc(c,13,22,2,1,v.hi);rc(c,17,22,2,1,v.hi);
}
function drawShoes(c,color){
  if(color==="None")return;const v=CLOTH[color];
  rc(c,10,28,6,2,v.base);rc(c,10,29,6,1,v.shade);px(c,10,28,v.shade);rc(c,11,28,4,1,v.hi);
  rc(c,16,28,6,2,v.base);rc(c,16,29,6,1,v.shade);px(c,21,28,v.shade);rc(c,17,28,4,1,v.hi);
}
function drawArmor(c,metal){
  if(metal==="None")return;const m=METAL[metal];
  rc(c,12,14,8,6,m.base);rc(c,12,14,1,6,m.shade);rc(c,19,14,1,6,m.shade);rc(c,12,19,8,1,m.shade);rc(c,14,14,4,1,m.hi);
  rc(c,8,13,3,2,m.base);rc(c,21,13,3,2,m.base);rc(c,8,13,3,1,m.hi);rc(c,21,13,3,1,m.hi);
  rc(c,8,14,1,1,m.shade);rc(c,23,14,1,1,m.shade);
  px(c,15,15,m.shade);px(c,16,15,m.shade);px(c,15,17,m.shade);px(c,16,17,m.shade);
}
function drawHelmet(c,metal){
  if(metal==="None")return;const m=METAL[metal];
  rc(c,11,1,10,4,m.base);rc(c,10,3,1,4,m.base);rc(c,21,3,1,4,m.base);
  rc(c,15,5,2,3,m.base);rc(c,10,5,1,2,m.shade);rc(c,21,5,1,2,m.shade);
  rc(c,11,1,10,1,m.hi);rc(c,15,5,2,1,m.hi);
}
function drawCrown(c,metal){
  if(metal==="None")return;const m=METAL[metal];
  rc(c,11,1,10,2,m.base);
  px(c,11,0,m.base);px(c,13,0,m.base);px(c,15,-1,m.base);px(c,16,-1,m.base);px(c,18,0,m.base);px(c,20,0,m.base);
  px(c,13,1,"#cc2222");px(c,15,0,"#2255cc");px(c,16,0,"#2255cc");px(c,18,1,"#22cc22");
  rc(c,12,1,8,1,m.hi);
}
function drawHood(c,color){
  if(color==="None")return;const v=CLOTH[color];
  rc(c,10,0,12,5,v.base);rc(c,9,3,1,6,v.base);rc(c,22,3,1,6,v.base);
  rc(c,10,0,12,1,v.hi);rc(c,9,7,1,2,v.shade);rc(c,22,7,1,2,v.shade);
  rc(c,10,5,1,6,v.shade);rc(c,21,5,1,6,v.shade);
}
function drawCape(c,color){
  if(color==="None")return;const v=CLOTH[color];
  rc(c,7,13,2,14,v.base);rc(c,23,13,2,14,v.base);rc(c,9,18,2,9,v.base);rc(c,21,18,2,9,v.base);
  rc(c,7,13,1,14,v.shade);rc(c,24,13,1,14,v.shade);rc(c,7,26,4,1,v.shade);rc(c,21,26,4,1,v.shade);
  rc(c,8,13,1,3,v.hi);rc(c,23,13,1,3,v.hi);
}
function drawSword(c){
  rc(c,6,5,1,12,"#c0c8d8");rc(c,7,5,1,12,"#a0a8b8");px(c,6,4,"#d0d8e8");px(c,7,4,"#d0d8e8");px(c,6,3,"#e0e8f0");
  rc(c,4,17,5,1,"#c8a030");px(c,4,17,"#a08020");rc(c,6,18,2,3,"#6b3a1a");px(c,6,19,"#8a5030");rc(c,6,21,2,1,"#c8a030");
}
function drawAxe(c){
  rc(c,6,8,1,14,"#6b3a1a");px(c,6,10,"#8a5030");px(c,6,14,"#8a5030");
  rc(c,3,6,4,4,"#a0a8b8");px(c,2,7,"#a0a8b8");px(c,2,8,"#a0a8b8");
  rc(c,3,6,4,1,"#c0c8d8");rc(c,3,9,4,1,"#707888");px(c,2,7,"#c0c8d8");
}
function drawStaff(c){
  rc(c,6,2,1,20,"#6b3a1a");px(c,6,5,"#8a5030");px(c,6,10,"#8a5030");px(c,6,15,"#8a5030");
  rc(c,5,0,3,3,"#6688dd");px(c,6,0,"#88aaff");px(c,5,2,"#4466aa");
}
function drawBow(c){
  const b="#6b3a1a",s="#999";
  [6,7].forEach(y=>px(c,3,y,b));px(c,4,8,b);[9,10,11,12,13].forEach(y=>px(c,5,y,b));
  px(c,4,14,b);[15,16].forEach(y=>px(c,3,y,b));
  [7,8,9,10,11,12,13,14,15].forEach(y=>px(c,6,y,s));
}
function drawShield(c,metal){
  if(metal==="None")return;const m=METAL[metal];
  rc(c,23,14,5,7,m.base);rc(c,24,13,3,1,m.base);rc(c,24,21,3,1,m.base);px(c,25,22,m.base);
  rc(c,27,14,1,7,m.shade);rc(c,24,21,3,1,m.shade);
  rc(c,24,14,1,3,m.hi);rc(c,24,13,3,1,m.hi);
  rc(c,25,15,1,4,m.shade);rc(c,24,17,3,1,m.shade);
}

function drawCharacter(canvas,o){
  const c=canvas.getContext("2d");
  c.imageSmoothingEnabled=false;
  c.clearRect(0,0,CW,CH);
  if(o.cape!=="None")drawCape(c,o.cape);
  drawBody(c,o.skin);drawEyes(c,o.eyes);drawMouth(c,o.skin);
  drawPants(c,o.pants);
  drawShoes(c,o.shoes);
  drawShirt(c,o.shirt);
  if(o.armor!=="None")drawArmor(c,o.armor);
  if(o.headgear==="Helmet")drawHelmet(c,o.headMetal);
  else if(o.headgear==="Crown")drawCrown(c,o.headMetal);
  else if(o.headgear==="Hood")drawHood(c,o.hoodColor);
  else drawHair(c,o.hairStyle,o.hairColor);
  if(o.weapon==="Sword")drawSword(c);
  else if(o.weapon==="Axe")drawAxe(c);
  else if(o.weapon==="Staff")drawStaff(c);
  else if(o.weapon==="Bow")drawBow(c);
  if(o.shield!=="None")drawShield(c,o.shield);
}

// ‚îÄ‚îÄ‚îÄ Sky colors per weather ‚îÄ‚îÄ‚îÄ
const SKY_COLORS = {
  Day:    {top:"#3878c8",mid:"#5898dd",low:"#88bbee",sun:true},
  Night:  {top:"#08081a",mid:"#101030",low:"#182048",moon:true},
  Sunset: {top:"#2a1848",mid:"#c85830",low:"#e8a830"},
  Rain:   {top:"#384858",mid:"#506070",low:"#687888"},
  Snow:   {top:"#788898",mid:"#8898a8",low:"#a0b0b8"},
  Storm:  {top:"#181828",mid:"#283040",low:"#384858"},
  Rainbow:{top:"#3878c8",mid:"#5898dd",low:"#88bbee",sun:true,rainbow:true},
  Foggy:  {top:"#607078",mid:"#788890",low:"#90a0a8"},
};

function drawSky(c, weather){
  const sk = SKY_COLORS[weather];
  // Gradient sky (3 bands)
  const band = Math.floor(GROUND_Y / 3);
  for(let y=0; y<GROUND_Y; y++){
    let col;
    if(y < band) col = sk.top;
    else if(y < band*2) col = sk.mid;
    else col = sk.low;
    rc(c, 0, y, SW, 1, col);
  }
  // Smooth blending between bands
  for(let y=0; y<GROUND_Y; y++){
    const t = y / GROUND_Y;
    let r,g,b;
    const c1 = hexToRgb(sk.top), c2 = hexToRgb(sk.mid), c3 = hexToRgb(sk.low);
    if(t < 0.5){
      const lt = t * 2;
      r=c1.r+(c2.r-c1.r)*lt; g=c1.g+(c2.g-c1.g)*lt; b=c1.b+(c2.b-c1.b)*lt;
    } else {
      const lt = (t-0.5)*2;
      r=c2.r+(c3.r-c2.r)*lt; g=c2.g+(c3.g-c2.g)*lt; b=c2.b+(c3.b-c2.b)*lt;
    }
    rc(c, 0, y, SW, 1, `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`);
  }
  // Sun
  if(sk.sun){
    rc(c, 105, 6, 6, 6, "#ffe844");
    rc(c, 106, 5, 4, 1, "#ffe844");
    rc(c, 106, 12, 4, 1, "#ffe844");
    rc(c, 104, 8, 1, 2, "#ffe844");
    rc(c, 112, 8, 1, 2, "#ffe844");
    rc(c, 106, 7, 4, 4, "#fff8aa");
  }
  // Moon
  if(sk.moon){
    rc(c, 100, 5, 8, 8, "#d8d8c0");
    rc(c, 101, 4, 6, 1, "#d8d8c0");
    rc(c, 101, 13, 6, 1, "#d8d8c0");
    rc(c, 102, 6, 4, 4, "#eeeecc");
    // Crater details
    px(c, 103, 7, "#c0c0a8");
    px(c, 106, 9, "#c0c0a8");
    px(c, 102, 10, "#c0c0a8");
  }
  // Rainbow arc
  if(sk.rainbow){
    const colors = ["#ff0000","#ff8800","#ffff00","#00cc00","#0066ff","#4400cc","#8800aa"];
    const cx = 64, cy = 50;
    colors.forEach((col, i) => {
      const r = 30 + i * 2;
      for(let a = 0; a < Math.PI; a += 0.04){
        const x = Math.round(cx + Math.cos(a+Math.PI) * r);
        const y = Math.round(cy + Math.sin(a+Math.PI) * r);
        if(y >= 0 && y < GROUND_Y && x >= 0 && x < SW) px(c, x, y, col);
      }
    });
  }
}

function hexToRgb(hex){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return {r,g,b};
}

// ‚îÄ‚îÄ‚îÄ Background drawing functions ‚îÄ‚îÄ‚îÄ
function drawBgMountains(c){
  // Far mountain range (dark blue-gray)
  tri(c, -10,GROUND_Y, 25,12, 55,GROUND_Y, "#3a4458");
  tri(c, 35,GROUND_Y, 65,8, 95,GROUND_Y, "#3a4458");
  tri(c, 80,GROUND_Y, 110,15, 138,GROUND_Y, "#3a4458");
  // Near mountain (lighter)
  tri(c, 10,GROUND_Y, 45,18, 80,GROUND_Y, "#4a5a6a");
  tri(c, 60,GROUND_Y, 95,14, 128,GROUND_Y, "#4a5a6a");
  // Snow caps
  tri(c, 20,14, 25,12, 30,14, "#e8e8f0");
  tri(c, 60,10, 65,8, 70,10, "#e8e8f0");
  tri(c, 105,17, 110,15, 115,17, "#e8e8f0");
  tri(c, 40,20, 45,18, 50,20, "#dde0e8");
  tri(c, 90,16, 95,14, 100,16, "#dde0e8");
  // Ground - rocky with grass
  rc(c, 0,GROUND_Y, SW,SH-GROUND_Y, "#4a6a38");
  rc(c, 0,GROUND_Y+4, SW, SH-GROUND_Y-4, "#3a5a28");
  // Pine trees (background, small)
  const trees = [8,22,38,55,72,90,108,118];
  trees.forEach(tx => {
    const th = 6 + (tx*3%4);
    rc(c, tx, GROUND_Y-1, 1, 3, "#3a2810");
    tri(c, tx-2, GROUND_Y-1, tx, GROUND_Y-th, tx+3, GROUND_Y-1, "#2a5a20");
    tri(c, tx-1, GROUND_Y-3, tx, GROUND_Y-th, tx+2, GROUND_Y-3, "#3a7a30");
  });
  // Rocks
  rc(c, 15, GROUND_Y+1, 4, 2, "#606868");
  rc(c, 85, GROUND_Y+2, 3, 2, "#586060");
  rc(c, 50, GROUND_Y+1, 5, 3, "#606868");
}

function drawBgBeach(c){
  // Ocean
  rc(c, 0, GROUND_Y-10, SW, 10, "#2868a8");
  rc(c, 0, GROUND_Y-8, SW, 8, "#3078b8");
  rc(c, 0, GROUND_Y-5, SW, 5, "#3888c8");
  // Wave crests
  for(let x=0; x<SW; x+=6){
    px(c, x, GROUND_Y-5, "#88ccee");
    px(c, x+1, GROUND_Y-5, "#88ccee");
    px(c, x+3, GROUND_Y-3, "#88ccee");
  }
  // Sand
  rc(c, 0, GROUND_Y, SW, SH-GROUND_Y, "#e0c878");
  rc(c, 0, GROUND_Y, SW, 2, "#d0b868");
  rc(c, 0, SH-4, SW, 4, "#c8b060");
  // Wet sand near water
  rc(c, 0, GROUND_Y, SW, 3, "#c0a850");
  // Palm tree (right side)
  rc(c, 110, GROUND_Y-18, 2, 18, "#8a6030");
  rc(c, 111, GROUND_Y-16, 1, 14, "#7a5020");
  // Fronds
  for(let i=0;i<5;i++) rc(c, 106+i*2, GROUND_Y-20+Math.abs(i-2), 2, 1, "#48a830");
  for(let i=0;i<6;i++) rc(c, 105+i*2, GROUND_Y-19+Math.abs(i-2.5)*0.8, 2, 1, "#58b840");
  rc(c, 112, GROUND_Y-18, 3, 1, "#48a830");
  rc(c, 113, GROUND_Y-17, 3, 1, "#48a830");
  // Shells
  px(c, 25, GROUND_Y+3, "#e8a8a8");
  px(c, 60, GROUND_Y+5, "#f0d0a0");
  px(c, 90, GROUND_Y+2, "#e8b8b8");
  // Starfish
  px(c, 40, GROUND_Y+4, "#e06060");
  px(c, 41, GROUND_Y+3, "#e06060");
  px(c, 39, GROUND_Y+3, "#e06060");
}

function drawBgPark(c){
  // Ground - grass
  rc(c, 0, GROUND_Y, SW, SH-GROUND_Y, "#4a8838");
  rc(c, 0, GROUND_Y+3, SW, SH-GROUND_Y-3, "#3a7828");
  // Path (winding through center)
  rc(c, 50, GROUND_Y, 20, SH-GROUND_Y, "#c8b878");
  rc(c, 52, GROUND_Y, 16, SH-GROUND_Y, "#d0c080");
  // Pond (left background)
  rc(c, 6, GROUND_Y-2, 16, 6, "#3888c8");
  rc(c, 7, GROUND_Y-3, 14, 1, "#3888c8");
  rc(c, 7, GROUND_Y+4, 14, 1, "#3888c8");
  rc(c, 8, GROUND_Y-1, 12, 4, "#48a8e0");
  // Trees (background)
  [[15,16],[35,18],[95,17],[115,14]].forEach(([tx,th])=>{
    rc(c, tx, GROUND_Y-3, 2, 4, "#5a3818");
    const cy = GROUND_Y - th;
    for(let dy=-1;dy<=1;dy++) rc(c, tx-4, cy+dy*3, 10, 3, "#2a7a28");
    for(let dy=-1;dy<=1;dy++) rc(c, tx-3, cy+dy*3+1, 8, 2, "#3a8a38");
  });
  // Bench
  rc(c, 80, GROUND_Y-3, 10, 1, "#6a4020");
  rc(c, 81, GROUND_Y-2, 1, 3, "#5a3018");
  rc(c, 88, GROUND_Y-2, 1, 3, "#5a3018");
  rc(c, 80, GROUND_Y-1, 10, 1, "#6a4020");
  // Flowers
  const flowerCols = ["#e84848","#e8e848","#e848e8","#ff8844","#8888ff"];
  [[5,3],[28,2],[45,4],[75,3],[100,2],[120,5]].forEach(([fx,fy])=>{
    px(c, fx, GROUND_Y+fy, flowerCols[(fx*7)%flowerCols.length]);
    px(c, fx+1, GROUND_Y+fy-1, "#48c848");
  });
}

function drawBgFarm(c){
  // Ground
  rc(c, 0, GROUND_Y, SW, SH-GROUND_Y, "#6a8a38");
  rc(c, 0, GROUND_Y+3, SW, SH-GROUND_Y-3, "#5a7a28");
  // Dirt path
  rc(c, 0, GROUND_Y+1, SW, 4, "#a08850");
  rc(c, 0, GROUND_Y+2, SW, 2, "#b09860");
  // Barn (left-ish background)
  rc(c, 8, GROUND_Y-18, 24, 18, "#b83020");
  rc(c, 8, GROUND_Y-18, 24, 2, "#d04030");
  rc(c, 8, GROUND_Y-2, 24, 2, "#901818");
  tri(c, 5, GROUND_Y-18, 20, GROUND_Y-26, 35, GROUND_Y-18, "#7a4020");
  tri(c, 7, GROUND_Y-18, 20, GROUND_Y-24, 33, GROUND_Y-18, "#8a5030");
  // Barn door
  rc(c, 16, GROUND_Y-10, 8, 10, "#5a3018");
  rc(c, 16, GROUND_Y-10, 8, 1, "#7a5030");
  rc(c, 20, GROUND_Y-10, 1, 10, "#4a2810");
  // Fence
  for(let x=40; x<SW; x+=8){
    rc(c, x, GROUND_Y-4, 1, 5, "#8a7040");
    if(x+8<SW) rc(c, x, GROUND_Y-3, 8, 1, "#a08850");
    if(x+8<SW) rc(c, x, GROUND_Y-1, 8, 1, "#a08850");
  }
  // Crop rows
  for(let row=0; row<3; row++){
    const ry = GROUND_Y + 6 + row * 3;
    for(let x=5; x<55; x+=3){
      px(c, x, ry, "#48a828");
      px(c, x, ry-1, "#58b838");
    }
  }
  // Windmill (far right background)
  rc(c, 112, GROUND_Y-20, 4, 20, "#d0c8b8");
  rc(c, 113, GROUND_Y-19, 2, 18, "#b8b0a0");
  // Blades
  rc(c, 114, GROUND_Y-28, 1, 8, "#888");
  rc(c, 107, GROUND_Y-19, 8, 1, "#888");
  rc(c, 114, GROUND_Y-20, 1, 8, "#888");
  rc(c, 115, GROUND_Y-19, 8, 1, "#888");
}

function drawBgCastle(c){
  // Ground - cobblestone
  rc(c, 0, GROUND_Y, SW, SH-GROUND_Y, "#686878");
  // Cobblestone pattern
  for(let y=GROUND_Y; y<SH; y+=3){
    for(let x=(y%6<3?0:2); x<SW; x+=5){
      rc(c, x, y, 4, 2, "#5a5a6a");
      px(c, x, y, "#787888");
    }
  }
  // Castle wall (spans background)
  rc(c, 0, GROUND_Y-25, SW, 25, "#8888a0");
  rc(c, 0, GROUND_Y-25, SW, 2, "#9898b0");
  rc(c, 0, GROUND_Y-2, SW, 2, "#686878");
  // Crenellations
  for(let x=0; x<SW; x+=6){
    rc(c, x, GROUND_Y-28, 4, 3, "#8888a0");
    rc(c, x, GROUND_Y-28, 4, 1, "#9898b0");
  }
  // Left tower
  rc(c, 5, GROUND_Y-38, 14, 38, "#7878a0");
  rc(c, 5, GROUND_Y-38, 14, 2, "#9090b8");
  tri(c, 3, GROUND_Y-38, 12, GROUND_Y-46, 21, GROUND_Y-38, "#6a3828");
  tri(c, 4, GROUND_Y-38, 12, GROUND_Y-44, 20, GROUND_Y-38, "#7a4838");
  // Flag on left tower
  rc(c, 12, GROUND_Y-47, 1, 6, "#5a3818");
  rc(c, 13, GROUND_Y-47, 5, 3, "#cc2828");
  rc(c, 13, GROUND_Y-47, 5, 1, "#e83838");
  // Right tower
  rc(c, 105, GROUND_Y-35, 14, 35, "#7878a0");
  rc(c, 105, GROUND_Y-35, 14, 2, "#9090b8");
  tri(c, 103, GROUND_Y-35, 112, GROUND_Y-43, 121, GROUND_Y-35, "#6a3828");
  tri(c, 104, GROUND_Y-35, 112, GROUND_Y-41, 120, GROUND_Y-35, "#7a4838");
  // Flag on right tower
  rc(c, 112, GROUND_Y-44, 1, 6, "#5a3818");
  rc(c, 113, GROUND_Y-44, 5, 3, "#2828cc");
  rc(c, 113, GROUND_Y-44, 5, 1, "#3838e8");
  // Gate arch (center)
  rc(c, 52, GROUND_Y-16, 20, 16, "#484858");
  rc(c, 54, GROUND_Y-14, 16, 14, "#383848");
  // Arch top
  for(let i=0;i<8;i++){
    const ax = 54 + i*2;
    const ay = GROUND_Y-14 - Math.round(Math.sqrt(64 - (i-4)*(i-4)));
    rc(c, ax, ay, 2, GROUND_Y-14-ay, "#383848");
  }
  // Torches
  px(c, 48, GROUND_Y-10, "#e8a830");
  px(c, 48, GROUND_Y-11, "#ff6030");
  px(c, 75, GROUND_Y-10, "#e8a830");
  px(c, 75, GROUND_Y-11, "#ff6030");
  // Window slits
  [[10,GROUND_Y-28],[14,GROUND_Y-22],[108,GROUND_Y-26],[114,GROUND_Y-20]].forEach(([wx,wy])=>{
    rc(c, wx, wy, 2, 4, "#282838");
  });
}

function drawBgMeadow(c){
  // Rolling hills
  for(let x=0; x<SW; x++){
    const h1 = Math.sin(x*0.05)*4 + Math.sin(x*0.02+1)*3;
    const h2 = Math.sin(x*0.04+2)*3 + Math.sin(x*0.015)*4;
    // Far hill
    const fy = GROUND_Y - 10 + Math.round(h1);
    rc(c, x, fy, 1, GROUND_Y-fy, "#4a8a38");
    // Near hill
    const ny = GROUND_Y - 3 + Math.round(h2*0.5);
    rc(c, x, ny, 1, GROUND_Y-ny, "#5a9a48");
  }
  // Main ground
  rc(c, 0, GROUND_Y, SW, SH-GROUND_Y, "#4a8838");
  rc(c, 0, GROUND_Y+4, SW, SH-GROUND_Y-4, "#3a7828");
  // Tall grass blades
  for(let x=2; x<SW; x+=3){
    const gh = 3 + (x*7%5);
    const gx = x + (x*3%3) - 1;
    rc(c, gx, GROUND_Y-gh, 1, gh, "#58a848");
    if(gh > 4) px(c, gx, GROUND_Y-gh, "#68b858");
  }
  // Wildflowers (many!)
  const fColors = ["#e84848","#e8e848","#e848e8","#ff8844","#4488ff","#ff88aa","#88ddff","#ffaa44"];
  for(let i=0; i<35; i++){
    const fx = (i*17+5) % SW;
    const fy = GROUND_Y - 1 - (i*13%6);
    px(c, fx, fy, fColors[i%fColors.length]);
  }
  // Butterflies (tiny colored dots in the air)
  px(c, 30, GROUND_Y-18, "#e848e8"); px(c, 31, GROUND_Y-18, "#e848e8");
  px(c, 85, GROUND_Y-22, "#e8e848"); px(c, 86, GROUND_Y-22, "#e8e848");
  px(c, 55, GROUND_Y-15, "#4488ff"); px(c, 56, GROUND_Y-15, "#4488ff");
}

const BG_DRAWERS = {
  Mountains: drawBgMountains,
  Beach: drawBgBeach,
  Park: drawBgPark,
  Farm: drawBgFarm,
  Castle: drawBgCastle,
  Meadow: drawBgMeadow,
};

// ‚îÄ‚îÄ‚îÄ Weather particle system ‚îÄ‚îÄ‚îÄ
let particles = [];
let lightningTimer = 0;

function resetParticles(){
  particles = [];
  lightningTimer = 0;
  const w = opts.weather;
  if(w === "Rain" || w === "Storm"){
    for(let i=0; i<80; i++)
      particles.push({x:Math.random()*SW, y:Math.random()*SH, speed:1.5+Math.random()*1.5, len:2+Math.random()*2});
  } else if(w === "Snow"){
    for(let i=0; i<50; i++)
      particles.push({x:Math.random()*SW, y:Math.random()*SH, speed:0.2+Math.random()*0.4, drift:(Math.random()-0.5)*0.3, size:Math.random()>0.7?2:1});
  } else if(w === "Night"){
    for(let i=0; i<35; i++)
      particles.push({x:Math.random()*SW, y:Math.random()*(GROUND_Y*0.75), phase:Math.random()*Math.PI*2, rate:0.5+Math.random()*2});
  } else if(w === "Foggy"){
    for(let i=0; i<10; i++)
      particles.push({x:Math.random()*SW*2-SW*0.5, y:15+Math.random()*40, w:25+Math.random()*35, h:6+Math.random()*10, speed:0.08+Math.random()*0.15, alpha:0.12+Math.random()*0.12});
  }
}

function updateParticles(ctx){
  const w = opts.weather;
  if(w === "Rain" || w === "Storm"){
    ctx.fillStyle = "rgba(180,200,220,0.5)";
    particles.forEach(p => {
      p.y += p.speed;
      p.x -= p.speed * 0.3;
      if(p.y > SH){ p.y = -p.len; p.x = Math.random()*SW; }
      if(p.x < -2) p.x = SW;
      ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 1, Math.min(Math.ceil(p.len), 3));
    });
    if(w === "Storm"){
      lightningTimer++;
      if(lightningTimer > 100 + Math.random()*200){
        ctx.fillStyle = "rgba(255,255,255,0.6)";
        ctx.fillRect(0, 0, SW, SH);
        lightningTimer = 0;
      }
    }
  } else if(w === "Snow"){
    particles.forEach(p => {
      p.y += p.speed;
      p.x += p.drift + Math.sin(Date.now()/2000 + p.x*0.5) * 0.08;
      if(p.y > SH){ p.y = -2; p.x = Math.random()*SW; }
      if(p.x < 0) p.x += SW;
      if(p.x >= SW) p.x -= SW;
      ctx.fillStyle = "rgba(255,255,255,0.75)";
      ctx.fillRect(Math.floor(p.x), Math.floor(p.y), p.size, p.size);
    });
  } else if(w === "Night"){
    particles.forEach(p => {
      p.phase += p.rate * 0.03;
      const bright = 0.25 + 0.75 * Math.abs(Math.sin(p.phase));
      ctx.fillStyle = `rgba(255,255,230,${bright.toFixed(2)})`;
      ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 1, 1);
    });
  } else if(w === "Foggy"){
    particles.forEach(p => {
      p.x += p.speed;
      if(p.x > SW + p.w/2) p.x = -p.w;
      ctx.fillStyle = `rgba(190,200,210,${p.alpha.toFixed(2)})`;
      // Soft fog blob
      const bx = Math.floor(p.x), by = Math.floor(p.y);
      ctx.fillRect(bx, by, Math.ceil(p.w), Math.ceil(p.h));
      ctx.fillStyle = `rgba(190,200,210,${(p.alpha*0.5).toFixed(2)})`;
      ctx.fillRect(bx-2, by+2, Math.ceil(p.w)+4, Math.ceil(p.h)-2);
    });
  }
}

// ‚îÄ‚îÄ‚îÄ Offscreen canvases ‚îÄ‚îÄ‚îÄ
const charCanvas = document.createElement("canvas");
charCanvas.width = CW; charCanvas.height = CH;

const bgCanvas = document.createElement("canvas");
bgCanvas.width = SW; bgCanvas.height = SH;

// ‚îÄ‚îÄ‚îÄ Scene composition ‚îÄ‚îÄ‚îÄ
function renderBackground(){
  const ctx = bgCanvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;
  ctx.clearRect(0, 0, SW, SH);
  if(opts.background === "None") return; // transparent
  if(opts.background === "Blank"){ rc(ctx, 0, 0, SW, SH, "#ffffff"); return; }
  drawSky(ctx, opts.weather);
  const drawer = BG_DRAWERS[opts.background];
  if(drawer) drawer(ctx);
}

function renderCharSprite(){
  drawCharacter(charCanvas, opts);
}

// ‚îÄ‚îÄ‚îÄ Animation loop ‚îÄ‚îÄ‚îÄ
const sceneCanvas = document.getElementById("sceneCanvas");
const sceneCtx = sceneCanvas.getContext("2d");
let animId = null;
let lastWeather = null;
let lastBg = null;

function animate(){
  sceneCtx.imageSmoothingEnabled = false;

  // Redraw background cache if changed
  if(opts.weather !== lastWeather || opts.background !== lastBg){
    renderBackground();
    lastWeather = opts.weather;
    lastBg = opts.background;
    resetParticles();
  }

  // Clear and draw cached background
  sceneCtx.clearRect(0, 0, SW, SH);
  if(opts.background !== "None") sceneCtx.drawImage(bgCanvas, 0, 0);

  // Character sizing & positioning
  const targetH = opts.height * PPF;
  const spriteContentH = 30; // character occupies ~30 of 32 px in sprite
  const scale = targetH / spriteContentH;
  const drawW = Math.round(CW * scale);
  const drawH = Math.round(CH * scale);
  const drawX = Math.round(SW/2 - drawW/2);
  const drawY = Math.round(GROUND_Y - targetH);
  sceneCtx.drawImage(charCanvas, 0, 0, CW, CH, drawX, drawY, drawW, drawH);

  // Weather particles on top (skip for transparent/blank background)
  if(opts.background !== "None" && opts.background !== "Blank") updateParticles(sceneCtx);

  animId = requestAnimationFrame(animate);
}

// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ
const HAIR_STYLES=["None","Short","Messy","Long","Mohawk","Ponytail","Curly","Spiky"];
const WEAPONS=["None","Sword","Axe","Staff","Bow"];
const HEADGEARS=["None","Helmet","Crown","Hood"];
const BACKGROUNDS=["None","Blank","Mountains","Beach","Park","Farm","Castle","Meadow"];
const WEATHERS=["Day","Night","Sunset","Rain","Snow","Storm","Rainbow","Foggy"];

const TABS=[
  {id:"body",label:"Body",icon:"üë§",sections:[
    {key:"skin",label:"Skin",type:"swatch",palette:SKIN},
    {key:"eyes",label:"Eyes",type:"swatch",palette:EYE,isFlat:true},
    {key:"height",label:"Height",type:"slider",min:1,max:12,step:1,suffix:" ft"},
  ]},
  {id:"hair",label:"Hair",icon:"üíá",sections:[
    {key:"hairStyle",label:"Style",type:"text",options:HAIR_STYLES},
    {key:"hairColor",label:"Color",type:"swatch",palette:HAIR_COLORS},
  ]},
  {id:"clothes",label:"Outfit",icon:"üëï",sections:[
    {key:"shirt",label:"Shirt",type:"swatch",palette:CLOTH},
    {key:"pants",label:"Pants",type:"swatch",palette:CLOTH},
    {key:"shoes",label:"Shoes",type:"swatch",palette:CLOTH},
  ]},
  {id:"armor",label:"Armor",icon:"üõ°Ô∏è",sections:[
    {key:"armor",label:"Plate",type:"swatch",palette:METAL,allowNone:true},
    {key:"headgear",label:"Head",type:"text",options:HEADGEARS},
    {key:"headMetal",label:"Metal",type:"swatch",palette:METAL,showIf:o=>o.headgear==="Helmet"||o.headgear==="Crown"},
    {key:"hoodColor",label:"Hood",type:"swatch",palette:CLOTH,showIf:o=>o.headgear==="Hood"},
  ]},
  {id:"weapons",label:"Arms",icon:"‚öîÔ∏è",sections:[
    {key:"weapon",label:"Weapon",type:"text",options:WEAPONS},
    {key:"shield",label:"Shield",type:"swatch",palette:METAL,allowNone:true},
    {key:"cape",label:"Cape",type:"swatch",palette:CLOTH,allowNone:true},
  ]},
  {id:"scene",label:"Scene",icon:"üåÑ",sections:[
    {key:"background",label:"Background",type:"text",options:BACKGROUNDS},
    {key:"weather",label:"Weather",type:"text",options:WEATHERS},
  ]},
];

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let opts = {
  skin:"Light", eyes:"Blue", height:6,
  hairStyle:"Short", hairColor:"Brown",
  shirt:"Teal", pants:"Blue", shoes:"Brown",
  armor:"None", headgear:"None", headMetal:"Steel", hoodColor:"Black",
  weapon:"None", shield:"None", cape:"None",
  background:"Meadow", weather:"Day",
};
let currentTab = "body";
let leftPct = 45;
let isDragging = false;

// ‚îÄ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ
const nameInput = document.getElementById("nameInput");
const nameplate = document.getElementById("nameplate");
const tabBar = document.getElementById("tabBar");
const optionsPanel = document.getElementById("optionsPanel");
const previewPanel = document.getElementById("previewPanel");
const mainArea = document.getElementById("mainArea");
const divider = document.getElementById("divider");
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");
const modalTitle = document.getElementById("modalTitle");
const modalClose = document.getElementById("modalClose");
const btnRandom = document.getElementById("btnRandom");
const btnSave = document.getElementById("btnSave");

// ‚îÄ‚îÄ‚îÄ Render UI ‚îÄ‚îÄ‚îÄ
function render(){
  renderCharSprite();
  nameplate.textContent = nameInput.value || "???";
  previewPanel.style.width = leftPct + "%";
  // Toggle checkerboard for transparent background
  document.querySelector(".scene").classList.toggle("transparent", opts.background === "None");
  // Force background re-render
  lastWeather = null;
  lastBg = null;
  renderTabs();
  renderOptions();
}

function renderTabs(){
  tabBar.innerHTML = "";
  TABS.forEach(t => {
    const btn = document.createElement("button");
    btn.className = "tab" + (currentTab===t.id?" on":"");
    btn.innerHTML = `<span class="icon">${t.icon}</span>${t.label}`;
    btn.addEventListener("click", () => { currentTab=t.id; renderTabs(); renderOptions(); });
    tabBar.appendChild(btn);
  });
}

function renderOptions(){
  optionsPanel.innerHTML = "";
  const tab = TABS.find(t => t.id===currentTab);
  if(!tab) return;

  tab.sections.forEach(sec => {
    if(sec.showIf && !sec.showIf(opts)) return;

    const div = document.createElement("div");
    div.className = "sec";

    const label = document.createElement("div");
    label.className = "sec-label";
    label.textContent = sec.label;
    div.appendChild(label);

    if(sec.type === "swatch"){
      const row = document.createElement("div");
      row.className = "swatches";

      if(sec.allowNone){
        const none = document.createElement("div");
        none.className = "sw sw-none" + (opts[sec.key]==="None"?" on":"");
        none.textContent = "‚úï";
        none.title = "None";
        none.addEventListener("click", () => { opts[sec.key]="None"; render(); });
        row.appendChild(none);
      }

      Object.entries(sec.palette).forEach(([k,v]) => {
        const sw = document.createElement("div");
        sw.className = "sw" + (opts[sec.key]===k?" on":"");
        sw.title = k;
        sw.style.background = sec.isFlat ? v : (v.base || v);
        sw.addEventListener("click", () => { opts[sec.key]=k; render(); });
        row.appendChild(sw);
      });

      div.appendChild(row);
    } else if(sec.type === "text"){
      const row = document.createElement("div");
      row.className = "textbtns";

      sec.options.forEach(o => {
        const btn = document.createElement("button");
        btn.className = "tx" + (opts[sec.key]===o?" on":"");
        btn.textContent = o;
        btn.addEventListener("click", () => { opts[sec.key]=o; render(); });
        row.appendChild(btn);
      });

      div.appendChild(row);
    } else if(sec.type === "slider"){
      const row = document.createElement("div");
      row.className = "slider-row";

      const slider = document.createElement("input");
      slider.type = "range";
      slider.min = sec.min;
      slider.max = sec.max;
      slider.step = sec.step;
      slider.value = opts[sec.key];

      const val = document.createElement("span");
      val.className = "slider-val";
      val.textContent = opts[sec.key] + (sec.suffix||"");

      slider.addEventListener("input", () => {
        opts[sec.key] = parseFloat(slider.value);
        val.textContent = opts[sec.key] + (sec.suffix||"");
        renderCharSprite();
        lastWeather = null; // force scene refresh
      });

      row.appendChild(slider);
      row.appendChild(val);
      div.appendChild(row);
    }

    optionsPanel.appendChild(div);
  });
}

// ‚îÄ‚îÄ‚îÄ Name input ‚îÄ‚îÄ‚îÄ
nameInput.addEventListener("input", () => {
  nameplate.textContent = nameInput.value || "???";
});

// ‚îÄ‚îÄ‚îÄ Draggable divider ‚îÄ‚îÄ‚îÄ
function startDrag(e){
  isDragging = true;
  document.body.style.cursor = "col-resize";
  document.body.style.userSelect = "none";
  e.preventDefault();
}
function onDrag(e){
  if(!isDragging) return;
  const rect = mainArea.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const pct = ((clientX-rect.left)/rect.width)*100;
  leftPct = Math.min(70, Math.max(25, pct));
  previewPanel.style.width = leftPct + "%";
}
function endDrag(){
  isDragging = false;
  document.body.style.cursor = "";
  document.body.style.userSelect = "";
}
divider.addEventListener("mousedown", startDrag);
divider.addEventListener("touchstart", startDrag, {passive:false});
window.addEventListener("mousemove", onDrag);
window.addEventListener("touchmove", onDrag, {passive:false});
window.addEventListener("mouseup", endDrag);
window.addEventListener("touchend", endDrag);

// ‚îÄ‚îÄ‚îÄ Random ‚îÄ‚îÄ‚îÄ
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
btnRandom.addEventListener("click", () => {
  opts = {
    skin:pick(Object.keys(SKIN)), eyes:pick(Object.keys(EYE)),
    height: 3 + Math.floor(Math.random()*8), // 3-10 ft
    hairStyle:pick(HAIR_STYLES), hairColor:pick(Object.keys(HAIR_COLORS)),
    shirt:pick(Object.keys(CLOTH)), pants:pick(Object.keys(CLOTH)),
    shoes:pick(Object.keys(CLOTH)), armor:pick(["None",...Object.keys(METAL)]),
    headgear:pick(["None","None","Helmet","Crown","Hood"]),
    headMetal:pick(Object.keys(METAL)), hoodColor:pick(Object.keys(CLOTH)),
    weapon:pick(["None","None","Sword","Axe","Staff","Bow"]),
    shield:pick(["None","None",...Object.keys(METAL)]),
    cape:pick(["None","None","None",...Object.keys(CLOTH)]),
    background:pick(BACKGROUNDS.filter(b=>b!=="None"&&b!=="Blank")), weather:pick(WEATHERS),
  };
  const names=["Shadow","Pixel","Storm","Ember","Frost","Blaze","Thorn","Sage","Rune","Hex","Jinx","Nova","Onyx","Vale","Wren","Ash","Bolt","Cinder","Drake","Echo"];
  nameInput.value = pick(names);
  render();
});

// ‚îÄ‚îÄ‚îÄ Export / Save ‚îÄ‚îÄ‚îÄ
btnSave.addEventListener("click", () => {
  const scale = 6;
  const expW = SW * scale;
  const bannerH = 40;
  const expH = SH * scale + bannerH;
  const off = document.createElement("canvas");
  off.width = expW;
  off.height = expH;
  const oc = off.getContext("2d");
  oc.imageSmoothingEnabled = false;

  // Draw the current scene frame (background + character + weather snapshot)
  // Re-render one clean frame
  const snapCtx = sceneCanvas.getContext("2d");
  // The current sceneCanvas already has the latest frame from the animation loop
  oc.drawImage(sceneCanvas, 0, 0, SW, SH, 0, 0, expW, SH*scale);

  // Name banner
  const nm = (nameInput.value || "").trim();
  if(nm){
    const bannerY = SH * scale;
    oc.fillStyle = "rgba(0,0,0,0.6)";
    oc.fillRect(0, bannerY, expW, bannerH);
    oc.fillStyle = "#64dcc8";
    oc.font = "bold 22px 'Silkscreen', monospace";
    oc.textAlign = "center";
    oc.textBaseline = "middle";
    oc.shadowColor = "rgba(0,0,0,0.7)";
    oc.shadowBlur = 4;
    oc.fillText(nm, expW/2, bannerY + bannerH/2);
    oc.shadowBlur = 0;
  }

  modalImg.src = off.toDataURL("image/png");
  modalTitle.textContent = nm || "Your Character";
  modal.style.display = "flex";
});

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ
modalClose.addEventListener("click", () => { modal.style.display="none"; });
modal.addEventListener("click", (e) => { if(e.target===modal) modal.style.display="none"; });

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
renderCharSprite();
renderBackground();
resetParticles();
renderTabs();
renderOptions();
nameplate.textContent = nameInput.value || "???";
previewPanel.style.width = leftPct + "%";
animate();
</script>
</body>
</html>
